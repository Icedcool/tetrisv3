(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function e(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=e(i);fetch(i.href,o)}})();const m=10,f=22,L=20,h=30,N=660,C=700,R=180,u=60,U=m*h,G=L*h,B=0,Y=510,gt="#0a0a2e",K="#111133",V="#3333aa",W="#ffffff",v="#8888bb",pt="rgba(255, 255, 255, 0.15)",Q={I:"#00f0f0",O:"#f0f000",T:"#a000f0",S:"#00f000",Z:"#f00000",J:"#0000f0",L:"#f0a000"},g=170,p=50,M=50,mt=500,yt=15,Z=200,rt=50,J=[1e3,793,618,473,355,262,190,135,94,64,43,28,18,11,7,4,3,2,1,1],wt={1:100,2:300,3:500,4:800},vt=1,St=2,Tt=10,X=["I","O","T","S","Z","J","L"],O={I:[[[1,0],[1,1],[1,2],[1,3]],[[0,2],[1,2],[2,2],[3,2]],[[2,0],[2,1],[2,2],[2,3]],[[0,1],[1,1],[2,1],[3,1]]],O:[[[0,1],[0,2],[1,1],[1,2]],[[0,1],[0,2],[1,1],[1,2]],[[0,1],[0,2],[1,1],[1,2]],[[0,1],[0,2],[1,1],[1,2]]],T:[[[0,1],[1,0],[1,1],[1,2]],[[0,1],[1,1],[1,2],[2,1]],[[1,0],[1,1],[1,2],[2,1]],[[0,1],[1,0],[1,1],[2,1]]],S:[[[0,1],[0,2],[1,0],[1,1]],[[0,1],[1,1],[1,2],[2,2]],[[1,1],[1,2],[2,0],[2,1]],[[0,0],[1,0],[1,1],[2,1]]],Z:[[[0,0],[0,1],[1,1],[1,2]],[[0,2],[1,1],[1,2],[2,1]],[[1,0],[1,1],[2,1],[2,2]],[[0,1],[1,0],[1,1],[2,0]]],J:[[[0,0],[1,0],[1,1],[1,2]],[[0,1],[0,2],[1,1],[2,1]],[[1,0],[1,1],[1,2],[2,2]],[[0,1],[1,1],[2,0],[2,1]]],L:[[[0,2],[1,0],[1,1],[1,2]],[[0,1],[1,1],[2,1],[2,2]],[[1,0],[1,1],[1,2],[2,0]],[[0,0],[0,1],[1,1],[2,1]]]},bt={"0>1":[[0,0],[0,-1],[-1,-1],[2,0],[2,-1]],"1>0":[[0,0],[0,1],[1,1],[-2,0],[-2,1]],"1>2":[[0,0],[0,1],[1,1],[-2,0],[-2,1]],"2>1":[[0,0],[0,-1],[-1,-1],[2,0],[2,-1]],"2>3":[[0,0],[0,1],[-1,1],[2,0],[2,1]],"3>2":[[0,0],[0,-1],[1,-1],[-2,0],[-2,-1]],"3>0":[[0,0],[0,-1],[1,-1],[-2,0],[-2,-1]],"0>3":[[0,0],[0,1],[-1,1],[2,0],[2,1]]},Rt={"0>1":[[0,0],[0,-2],[0,1],[-1,-2],[2,1]],"1>0":[[0,0],[0,2],[0,-1],[1,2],[-2,-1]],"1>2":[[0,0],[0,-1],[0,2],[2,-1],[-1,2]],"2>1":[[0,0],[0,1],[0,-2],[-2,1],[1,-2]],"2>3":[[0,0],[0,2],[0,-1],[1,2],[-2,-1]],"3>2":[[0,0],[0,-2],[0,1],[-1,-2],[2,1]],"3>0":[[0,0],[0,1],[0,-2],[-2,1],[1,-2]],"0>3":[[0,0],[0,-1],[0,2],[2,-1],[-1,2]]},Et=0,kt=3,Lt=3,xt=20;class ${constructor(){this._listeners=new Map}on(t,e){return this._listeners.has(t)||this._listeners.set(t,new Set),this._listeners.get(t).add(e),this}off(t,e){const s=this._listeners.get(t);return s&&(s.delete(e),s.size===0&&this._listeners.delete(t)),this}emit(t,...e){const s=this._listeners.get(t);if(s)for(const i of s)i(...e);return this}}class At{constructor(){this.grid=this._createGrid()}_createGrid(){return Array.from({length:f},()=>Array(m).fill(null))}reset(){this.grid=this._createGrid()}isValidPosition(t,e=0,s=0){const i=t.row+e,o=t.col+s;for(const[r,c]of t.cells){const a=i+r,d=o+c;if(a<0||a>=f||d<0||d>=m||this.grid[a][d]!==null)return!1}return!0}checkPosition(t,e,s){for(const[i,o]of t){const r=e+i,c=s+o;if(r<0||r>=f||c<0||c>=m||this.grid[r][c]!==null)return!1}return!0}placePiece(t){for(const[e,s]of t.cells){const i=t.row+e,o=t.col+s;i>=0&&i<f&&o>=0&&o<m&&(this.grid[i][o]=t.type)}}getFullRows(){const t=[];for(let e=0;e<f;e++)this.grid[e].every(s=>s!==null)&&t.push(e);return t}clearRows(t){const e=[...t].sort((s,i)=>i-s);for(const s of e)this.grid.splice(s,1);for(;this.grid.length<f;)this.grid.unshift(Array(m).fill(null))}getGhostRow(t){let e=0;for(;this.isValidPosition(t,e+1,0);)e++;return t.row+e}}class T{constructor(t){this.type=t,this.rotation=0,this.row=Et,this.col=kt}get cells(){return O[this.type][this.rotation]}clone(){const t=new T(this.type);return t.rotation=this.rotation,t.row=this.row,t.col=this.col,t}absoluteCells(){return this.cells.map(([t,e])=>[this.row+t,this.col+e])}}class Pt{constructor(){this._bag=[]}next(){return this._bag.length===0&&this._refill(),this._bag.pop()}peek(t){for(;this._bag.length<t;)this._refill();const e=[];for(let s=this._bag.length-1;s>=0&&e.length<t;s--)e.push(this._bag[s]);return e}reset(){this._bag=[]}_refill(){const t=[...X];for(let e=t.length-1;e>0;e--){const s=Math.floor(Math.random()*(e+1));[t[e],t[s]]=[t[s],t[e]]}this._bag=t.concat(this._bag)}}class Dt extends ${constructor(){super(),this.board=new At,this.bag=new Pt,this._resetState()}_resetState(){this.state="menu",this.piece=null,this.holdType=null,this.holdUsed=!1,this.score=0,this.lines=0,this.level=1,this.nextQueue=[],this.gravityTimer=0,this.lockTimer=0,this.lockResets=0,this.isLocking=!1,this.clearingRows=null,this.clearTimer=0}startGame(){this.board.reset(),this.bag.reset(),this._resetState(),this.state="playing",this._fillNextQueue(),this._spawnPiece(),this.emit("state-changed",this.state),this.emit("game-started")}pause(){this.state==="playing"&&(this.state="paused",this.emit("state-changed",this.state))}resume(){this.state==="paused"&&(this.state="playing",this.emit("state-changed",this.state))}togglePause(){this.state==="playing"?this.pause():this.state==="paused"&&this.resume()}returnToMenu(){this._resetState(),this.board.reset(),this.emit("state-changed",this.state)}update(t){if(this.state!=="playing")return;if(this.clearingRows){this.clearTimer+=t,this.clearTimer>=Z&&this._finishLineClear();return}if(!this.piece)return;const e=this._getGravityInterval();for(this.gravityTimer+=t;this.gravityTimer>=e&&this.piece&&!this.isLocking;)this.gravityTimer-=e,this._applyGravity();this.isLocking&&(this.lockTimer+=t,this.lockTimer>=mt&&this._lockPiece())}moveLeft(){return this.state!=="playing"||!this.piece||this.clearingRows?!1:this.board.isValidPosition(this.piece,0,-1)?(this.piece.col--,this._onSuccessfulMove(),!0):!1}moveRight(){return this.state!=="playing"||!this.piece||this.clearingRows?!1:this.board.isValidPosition(this.piece,0,1)?(this.piece.col++,this._onSuccessfulMove(),!0):!1}softDrop(){return this.state!=="playing"||!this.piece||this.clearingRows?!1:this.board.isValidPosition(this.piece,1,0)?(this.piece.row++,this.score+=vt,this.gravityTimer=0,this._onSuccessfulMove(),this.emit("score-updated",this.score),!0):!1}hardDrop(){if(this.state!=="playing"||!this.piece||this.clearingRows)return!1;let t=0;for(;this.board.isValidPosition(this.piece,t+1,0);)t++;return this.piece.row+=t,this.score+=t*St,this.emit("score-updated",this.score),this._lockPiece(),!0}rotateCW(){return this._rotate(1)}rotateCCW(){return this._rotate(-1)}holdPiece(){if(this.state!=="playing"||!this.piece||this.holdUsed||this.clearingRows)return!1;const t=this.piece.type;if(this.holdType){if(this.piece=new T(this.holdType),!this.board.isValidPosition(this.piece)&&(this.piece.row--,!this.board.isValidPosition(this.piece)))return this.piece=new T(t),!1}else{this._fillNextQueue();const e=this.nextQueue.shift();if(this.nextQueue.push(this.bag.next()),this.piece=new T(e),!this.board.isValidPosition(this.piece)&&(this.piece.row--,!this.board.isValidPosition(this.piece)))return this._gameOver(),!1;this.emit("next-updated",this.nextQueue.slice())}return this.holdType=t,this.holdUsed=!0,this.isLocking=!1,this.lockTimer=0,this.lockResets=0,this.gravityTimer=0,this.emit("hold-changed",this.holdType),!0}getState(){return{state:this.state,board:this.board.grid,piece:this.piece,ghostRow:this.piece?this.board.getGhostRow(this.piece):null,holdType:this.holdType,holdUsed:this.holdUsed,nextQueue:this.nextQueue.slice(),score:this.score,lines:this.lines,level:this.level,clearingRows:this.clearingRows,clearProgress:this.clearingRows?this.clearTimer/Z:0}}_fillNextQueue(){for(;this.nextQueue.length<Lt;)this.nextQueue.push(this.bag.next())}_spawnPiece(){this._fillNextQueue();const t=this.nextQueue.shift();if(this.nextQueue.push(this.bag.next()),this.piece=new T(t),this.isLocking=!1,this.lockTimer=0,this.lockResets=0,this.gravityTimer=0,this.holdUsed=!1,!this.board.isValidPosition(this.piece)&&(this.piece.row--,!this.board.isValidPosition(this.piece))){this._gameOver();return}this.emit("next-updated",this.nextQueue.slice())}_applyGravity(){this.board.isValidPosition(this.piece,1,0)?(this.piece.row++,this._checkLanding()):this.isLocking||(this.isLocking=!0,this.lockTimer=0)}_checkLanding(){this.board.isValidPosition(this.piece,1,0)?(this.isLocking=!1,this.lockTimer=0):this.isLocking||(this.isLocking=!0,this.lockTimer=0)}_onSuccessfulMove(){this.isLocking&&this.lockResets<yt&&(this.lockTimer=0,this.lockResets++),this._checkLanding()}_rotate(t){if(this.state!=="playing"||!this.piece||this.clearingRows||this.piece.type==="O")return!1;const e=this.piece.rotation,s=(e+t+4)%4,i=`${e}>${s}`,r=(this.piece.type==="I"?Rt:bt)[i];if(!r)return!1;const c=O[this.piece.type][s];for(const[a,d]of r)if(this.board.checkPosition(c,this.piece.row+a,this.piece.col+d))return this.piece.rotation=s,this.piece.row+=a,this.piece.col+=d,this._onSuccessfulMove(),!0;return!1}_lockPiece(){this.board.placePiece(this.piece),this.emit("piece-locked",this.piece);const t=this.board.getFullRows();t.length>0?(this.clearingRows=t,this.clearTimer=0,this.piece=null,this.emit("lines-clearing",t)):(this.piece=null,this._spawnPiece())}_finishLineClear(){const t=this.clearingRows.length;this.board.clearRows(this.clearingRows),this.clearingRows=null,this.clearTimer=0;const e=(wt[t]||0)*this.level;this.score+=e,this.lines+=t;const s=Math.floor(this.lines/Tt)+1;s!==this.level&&(this.level=s),this.emit("lines-cleared",t),this.emit("score-updated",this.score),this._spawnPiece()}_getGravityInterval(){const t=Math.min(this.level-1,J.length-1);return J[t]}_gameOver(){this.state="gameOver",this.piece=null,this.emit("game-over",{score:this.score,lines:this.lines,level:this.level}),this.emit("state-changed",this.state)}}const z={ArrowLeft:"left",ArrowRight:"right",ArrowDown:"softDrop",ArrowUp:"rotateCW",KeyX:"rotateCW",KeyZ:"rotateCCW",Space:"hardDrop",ShiftLeft:"hold",ShiftRight:"hold",KeyC:"hold",Escape:"pause",KeyP:"pause"};class Ct extends ${constructor(){super(),this._keys=new Set,this._dasTimers={left:0,right:0},this._dasActive={left:!1,right:!1},this._softDropTimer=0,this._enabled=!1,this._onKeyDown=this._onKeyDown.bind(this),this._onKeyUp=this._onKeyUp.bind(this)}enable(){this._enabled||(this._enabled=!0,window.addEventListener("keydown",this._onKeyDown),window.addEventListener("keyup",this._onKeyUp))}disable(){this._enabled=!1,window.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("keyup",this._onKeyUp),this._keys.clear()}update(t){if(this._keys.has("left"))if(this._dasTimers.left+=t,this._dasActive.left)for(;this._dasTimers.left>=p;)this._dasTimers.left-=p,this.emit("action","left");else this._dasTimers.left>=g&&(this._dasActive.left=!0,this._dasTimers.left-=g,this.emit("action","left"));if(this._keys.has("right"))if(this._dasTimers.right+=t,this._dasActive.right)for(;this._dasTimers.right>=p;)this._dasTimers.right-=p,this.emit("action","right");else this._dasTimers.right>=g&&(this._dasActive.right=!0,this._dasTimers.right-=g,this.emit("action","right"));if(this._keys.has("softDrop"))for(this._softDropTimer+=t;this._softDropTimer>=M;)this._softDropTimer-=M,this.emit("action","softDrop")}_onKeyDown(t){const e=z[t.code];if(e&&(t.preventDefault(),!this._keys.has(e)))switch(this._keys.add(e),e){case"left":this._dasTimers.left=0,this._dasActive.left=!1,this.emit("action","left");break;case"right":this._dasTimers.right=0,this._dasActive.right=!1,this.emit("action","right");break;case"softDrop":this._softDropTimer=0,this.emit("action","softDrop");break;case"rotateCW":case"rotateCCW":case"hardDrop":case"hold":case"pause":this.emit("action",e);break}}_onKeyUp(t){const e=z[t.code];e&&(this._keys.delete(e),e==="left"&&(this._dasTimers.left=0,this._dasActive.left=!1),e==="right"&&(this._dasTimers.right=0,this._dasActive.right=!1),e==="softDrop"&&(this._softDropTimer=0))}}const j={"btn-left":"left","btn-right":"right","btn-softdrop":"softDrop","btn-harddrop":"hardDrop","btn-rotatecw":"rotateCW","btn-rotateccw":"rotateCCW","btn-hold":"hold","btn-pause":"pause"},Mt=new Set(["left","right","softDrop"]);class Ot extends ${constructor(){super(),this._held=new Set,this._dasTimers={left:0,right:0},this._dasActive={left:!1,right:!1},this._softDropTimer=0,this._onTouchStart=this._onTouchStart.bind(this),this._onTouchEnd=this._onTouchEnd.bind(this)}bind(t){t.addEventListener("touchstart",this._onTouchStart,{passive:!1}),t.addEventListener("touchend",this._onTouchEnd,{passive:!1}),t.addEventListener("touchcancel",this._onTouchEnd,{passive:!1})}update(t){if(this._held.has("left"))if(this._dasTimers.left+=t,this._dasActive.left)for(;this._dasTimers.left>=p;)this._dasTimers.left-=p,this.emit("action","left");else this._dasTimers.left>=g&&(this._dasActive.left=!0,this._dasTimers.left-=g,this.emit("action","left"));if(this._held.has("right"))if(this._dasTimers.right+=t,this._dasActive.right)for(;this._dasTimers.right>=p;)this._dasTimers.right-=p,this.emit("action","right");else this._dasTimers.right>=g&&(this._dasActive.right=!0,this._dasTimers.right-=g,this.emit("action","right"));if(this._held.has("softDrop"))for(this._softDropTimer+=t;this._softDropTimer>=M;)this._softDropTimer-=M,this.emit("action","softDrop")}_onTouchStart(t){t.preventDefault();for(const e of t.changedTouches){const s=e.target.closest("[data-touch]");if(!s)continue;const i=j[s.dataset.touch];if(i){if(Mt.has(i)){if(this._held.has(i))continue;this._held.add(i),i==="left"?(this._dasTimers.left=0,this._dasActive.left=!1):i==="right"?(this._dasTimers.right=0,this._dasActive.right=!1):i==="softDrop"&&(this._softDropTimer=0)}this.emit("action",i),s.classList.add("touch-btn--active")}}}_onTouchEnd(t){t.preventDefault();for(const e of t.changedTouches){const s=e.target.closest("[data-touch]");if(!s)continue;const i=j[s.dataset.touch];i&&(i==="left"?(this._held.delete("left"),this._dasTimers.left=0,this._dasActive.left=!1):i==="right"?(this._held.delete("right"),this._dasTimers.right=0,this._dasActive.right=!1):i==="softDrop"&&(this._held.delete("softDrop"),this._softDropTimer=0),s.classList.remove("touch-btn--active"))}}}class It{constructor(t){this.canvas=t,this.ctx=t.getContext("2d"),this.canvas.width=N,this.canvas.height=C}clear(){this.ctx.fillStyle=gt,this.ctx.fillRect(0,0,N,C)}drawBlock(t,e,s,i,o=1){const r=this.ctx,c=typeof i=="string"&&Q[i]?Q[i]:i;r.globalAlpha=o,r.fillStyle=c,r.fillRect(t,e,s,s),r.fillStyle="rgba(255, 255, 255, 0.2)",r.fillRect(t,e,s,1),r.fillRect(t,e,1,s),r.fillStyle="rgba(0, 0, 0, 0.3)",r.fillRect(t,e+s-1,s,1),r.fillRect(t+s-1,e,1,s),r.globalAlpha=1}drawBoardBackground(){const t=this.ctx;t.fillStyle=K,t.fillRect(R,u,U,G),t.strokeStyle=V,t.lineWidth=2,t.strokeRect(R-1,u-1,U+2,G+2)}}class Ht{constructor(t){this.renderer=t,this.ctx=t.ctx}draw(t){this.renderer.drawBoardBackground(),this._drawLockedBlocks(t.board),t.piece&&!t.clearingRows&&(this._drawGhost(t.piece,t.ghostRow),this._drawActivePiece(t.piece))}_drawLockedBlocks(t){const e=f-L;for(let s=e;s<f;s++)for(let i=0;i<m;i++){const o=t[s][i];if(o){const r=R+i*h,c=u+(s-e)*h;this.renderer.drawBlock(r,c,h,o)}}}_drawGhost(t,e){const s=f-L;for(const[i,o]of t.cells){const r=e+i,c=t.col+o;if(r>=s){const a=R+c*h,d=u+(r-s)*h,_=this.ctx;_.fillStyle=pt,_.fillRect(a,d,h,h),_.strokeStyle="rgba(255, 255, 255, 0.2)",_.lineWidth=1,_.strokeRect(a+.5,d+.5,h-1,h-1)}}}_drawActivePiece(t){const e=f-L;for(const[s,i]of t.cells){const o=t.row+s,r=t.col+i;if(o>=e){const c=R+r*h,a=u+(o-e)*h;this.renderer.drawBlock(c,a,h,t.type)}}}}class Bt{constructor(t,e=!1){this.renderer=t,this.ctx=t.ctx,this._isTouchDevice=e}draw(t){this._drawHold(t),this._drawNext(t),this._drawScore(t),this._drawLevel(t),this._isTouchDevice||this._drawControls()}_drawHold(t){const e=this.ctx,s=B+15,i=u,o=120,r=80;if(e.fillStyle=v,e.font='12px "Segoe UI", sans-serif',e.textAlign="center",e.fillText("HOLD",s+o/2,i-8),e.fillStyle=K,e.fillRect(s,i,o,r),e.strokeStyle=V,e.lineWidth=1,e.strokeRect(s,i,o,r),t.holdType){const c=t.holdUsed?.3:1;this._drawPreviewPiece(t.holdType,s+o/2,i+r/2,c)}}_drawNext(t){const e=this.ctx,s=Y+15,i=u,o=120,r=60;e.fillStyle=v,e.font='12px "Segoe UI", sans-serif',e.textAlign="center",e.fillText("NEXT",s+o/2,i-8);const c=r*t.nextQueue.length;e.fillStyle=K,e.fillRect(s,i,o,c),e.strokeStyle=V,e.lineWidth=1,e.strokeRect(s,i,o,c);for(let a=0;a<t.nextQueue.length;a++)this._drawPreviewPiece(t.nextQueue[a],s+o/2,i+r/2+a*r,1)}_drawScore(t){const e=this.ctx,s=B+75,i=u+120;e.textAlign="center",e.fillStyle=v,e.font='12px "Segoe UI", sans-serif',e.fillText("SCORE",s,i),e.fillStyle=W,e.font='bold 20px "Segoe UI", sans-serif',e.fillText(t.score.toLocaleString(),s,i+24),e.fillStyle=v,e.font='12px "Segoe UI", sans-serif',e.fillText("LINES",s,i+56),e.fillStyle=W,e.font='bold 20px "Segoe UI", sans-serif',e.fillText(t.lines.toString(),s,i+80)}_drawLevel(t){const e=this.ctx,s=Y+75,i=u+220;e.textAlign="center",e.fillStyle=v,e.font='12px "Segoe UI", sans-serif',e.fillText("LEVEL",s,i),e.fillStyle=W,e.font='bold 24px "Segoe UI", sans-serif',e.fillText(t.level.toString(),s,i+28)}_drawControls(){const t=this.ctx,e=B+75,s=u+G-120;t.textAlign="center",t.fillStyle=v,t.font='10px "Segoe UI", sans-serif',["← → Move","↑ / X  Rotate CW","Z  Rotate CCW","↓  Soft Drop","Space  Hard Drop","Shift/C  Hold","Esc/P  Pause"].forEach((o,r)=>{t.fillText(o,e,s+r*16)})}_drawPreviewPiece(t,e,s,i){const o=O[t][0],r=xt;let c=1/0,a=-1/0,d=1/0,_=-1/0;for(const[A,P]of o)c=Math.min(c,A),a=Math.max(a,A),d=Math.min(d,P),_=Math.max(_,P);const at=(_-d+1)*r,ht=(a-c+1)*r,dt=e-at/2,ft=s-ht/2;for(const[A,P]of o){const ut=dt+(P-d)*r,_t=ft+(A-c)*r;this.renderer.drawBlock(ut,_t,r,t,i)}}}class Wt{constructor(){this._clearingRows=null}startLineClear(t){this._clearingRows=t}clear(){this._clearingRows=null}draw(t,e){if(!e.clearingRows||e.clearProgress===void 0)return;const s=t.ctx,i=f-L,o=e.clearProgress,r=.6*Math.abs(Math.sin(o*Math.PI*2));s.fillStyle=`rgba(255, 255, 255, ${r})`;for(const c of e.clearingRows)if(c>=i){const a=u+(c-i)*h;s.fillRect(R,a,U,h)}}}const Nt=12,Ut=30,Gt=80,Kt=.1,Vt=.3,Qt=15,Xt=25;function S(n,t){return n+Math.random()*(t-n)}function tt(){const n=X[Math.floor(Math.random()*X.length)],t=Math.floor(Math.random()*4);return{type:n,rotation:t,x:S(0,N),y:S(-200,-20),speed:S(Ut,Gt),opacity:S(Kt,Vt),cellSize:S(Qt,Xt)}}class $t{constructor(t){this.renderer=t,this.ctx=t.ctx,this._pieces=[];for(let e=0;e<Nt;e++){const s=tt();s.y=S(-200,C),this._pieces.push(s)}}update(t){const e=t/1e3;for(const s of this._pieces)s.y+=s.speed*e,s.y>C+100&&Object.assign(s,tt())}draw(){for(const t of this._pieces){const e=O[t.type][t.rotation],s=Q[t.type],i=this.ctx;i.globalAlpha=t.opacity;for(const[o,r]of e){const c=t.x+r*t.cellSize,a=t.y+o*t.cellSize;i.fillStyle=s,i.fillRect(c,a,t.cellSize,t.cellSize),i.strokeStyle="rgba(255,255,255,0.1)",i.lineWidth=1,i.strokeRect(c+.5,a+.5,t.cellSize-1,t.cellSize-1)}}this.ctx.globalAlpha=1}}class qt{constructor(t,e,s=!1){this._container=t,this._highScores=e,this._isTouchDevice=s,this._el=null,this._keyHandler=null,this.onPlay=null}show(){this._el&&this.hide();const t=document.createElement("div");t.className="overlay",t.innerHTML=`
      <div class="menu-card">
        <div class="menu-card__title">TETRIS</div>
        <div class="menu-card__version">v3</div>
        <button class="overlay__btn menu-card__play" data-action="play">PLAY</button>
        <div class="menu-card__hint">${this._isTouchDevice?"Tap to play":"or press Enter"}</div>
        <div class="overlay__high-scores"></div>
        <div class="menu-card__divider"></div>
        <div class="menu-card__controls">
          ${this._isTouchDevice?`
          <h4>Controls</h4>
          <p style="font-size:13px;color:#999;text-align:center;">Use the buttons below to play</p>
          `:`
          <h4>Controls</h4>
          <table>
            <tr><td>← →</td><td>Move</td></tr>
            <tr><td>↑ / X</td><td>Rotate CW</td></tr>
            <tr><td>Z</td><td>Rotate CCW</td></tr>
            <tr><td>↓</td><td>Soft Drop</td></tr>
            <tr><td>Space</td><td>Hard Drop</td></tr>
            <tr><td>Shift / C</td><td>Hold Piece</td></tr>
            <tr><td>Esc / P</td><td>Pause</td></tr>
          </table>
          `}
        </div>
      </div>
    `,t.querySelector('[data-action="play"]').addEventListener("click",()=>{this.onPlay&&this.onPlay()}),this._keyHandler=e=>{(e.code==="Enter"||e.code==="Space")&&(e.preventDefault(),this.onPlay&&this.onPlay())},window.addEventListener("keydown",this._keyHandler),this._renderScores(t.querySelector(".overlay__high-scores")),this._container.appendChild(t),this._el=t}hide(){this._keyHandler&&(window.removeEventListener("keydown",this._keyHandler),this._keyHandler=null),this._el&&(this._el.remove(),this._el=null)}_renderScores(t){const e=this._highScores.getScores();if(e.length===0)return;let s="<h3>High Scores</h3><ol>";for(const i of e)s+=`<li>${i.score.toLocaleString()} — Lv.${i.level} — ${i.lines} lines</li>`;s+="</ol>",t.innerHTML=s}}class Ft{constructor(t,e=!1){this._container=t,this._isTouchDevice=e,this._el=null,this._keyHandler=null,this.onResume=null,this.onMenu=null}show(){this._el&&this.hide();const t=document.createElement("div");t.className="overlay overlay--dim",t.innerHTML=`
      <div class="menu-card">
        <div class="menu-card__title">PAUSED</div>
        <button class="overlay__btn menu-card__play" data-action="resume">RESUME</button>
        <div class="menu-card__hint">${this._isTouchDevice?"Tap Resume to continue":"or press Esc"}</div>
        <div class="menu-card__divider"></div>
        <button class="overlay__btn" data-action="menu">MAIN MENU</button>
      </div>
    `,t.querySelector('[data-action="resume"]').addEventListener("click",()=>{this.onResume&&this.onResume()}),t.querySelector('[data-action="menu"]').addEventListener("click",()=>{this.onMenu&&this.onMenu()}),this._keyHandler=e=>{(e.code==="Escape"||e.code==="KeyP")&&(e.preventDefault(),this.onResume&&this.onResume())},window.addEventListener("keydown",this._keyHandler),this._container.appendChild(t),this._el=t,t.querySelector('[data-action="resume"]').focus()}hide(){this._keyHandler&&(window.removeEventListener("keydown",this._keyHandler),this._keyHandler=null),this._el&&(this._el.remove(),this._el=null)}}class Yt{constructor(t,e){this._container=t,this._highScores=e,this._el=null,this.onRestart=null,this.onMenu=null}show(t){this._el&&this.hide();const e=this._highScores.isHighScore(t.score),s=document.createElement("div");s.className="overlay overlay--dim",s.innerHTML=`
      <div class="overlay__title">GAME OVER</div>
      ${e?'<div class="overlay__new-high">NEW HIGH SCORE!</div>':""}
      <div class="overlay__score">Score: ${t.score.toLocaleString()}</div>
      <div class="overlay__subtitle">Level ${t.level} — ${t.lines} Lines</div>
      <button class="overlay__btn" data-action="restart">PLAY AGAIN</button>
      <button class="overlay__btn" data-action="menu">MAIN MENU</button>
    `,s.querySelector('[data-action="restart"]').addEventListener("click",()=>{this.onRestart&&this.onRestart()}),s.querySelector('[data-action="menu"]').addEventListener("click",()=>{this.onMenu&&this.onMenu()}),this._container.appendChild(s),this._el=s,s.querySelector('[data-action="restart"]').focus()}hide(){this._el&&(this._el.remove(),this._el=null)}}class Zt{constructor(t,e,s,i=!1){this._container=t,this._engine=e,this._highScores=s,this.menu=new qt(t,s,i),this.pause=new Ft(t,i),this.gameOver=new Yt(t,s),this.onPlay=null,this.onResume=null,this.onReturnToMenu=null,this._wireScreenCallbacks(),this._wireEngineEvents()}_wireScreenCallbacks(){this.menu.onPlay=()=>{this.menu.hide(),this.onPlay&&this.onPlay()},this.pause.onResume=()=>{this.pause.hide(),this.onResume&&this.onResume()},this.pause.onMenu=()=>{this.pause.hide(),this.onReturnToMenu&&this.onReturnToMenu()},this.gameOver.onRestart=()=>{this.gameOver.hide(),this.onPlay&&this.onPlay()},this.gameOver.onMenu=()=>{this.gameOver.hide(),this.onReturnToMenu&&this.onReturnToMenu()}}_wireEngineEvents(){this._engine.on("state-changed",t=>{switch(this._hideAll(),t){case"menu":this.menu.show();break;case"paused":this.pause.show();break}}),this._engine.on("game-over",t=>{setTimeout(()=>{this.gameOver.show(t)},300)})}_hideAll(){this.menu.hide(),this.pause.hide(),this.gameOver.hide()}showMenu(){this._hideAll(),this.menu.show()}}const et="tetrisv3_highscores",st=10;class Jt{getScores(){try{const t=localStorage.getItem(et);return t?JSON.parse(t):[]}catch{return[]}}addScore(t){const e=this.getScores();e.push(t),e.sort((i,o)=>o.score-i.score);const s=e.slice(0,st);try{localStorage.setItem(et,JSON.stringify(s))}catch{}return s}isHighScore(t){const e=this.getScores();return e.length<st?!0:t>e[e.length-1].score}}const I="ontouchstart"in window,zt=document.getElementById("game-canvas"),jt=document.getElementById("overlay-container");document.getElementById("game-container");const D=document.getElementById("device-shell"),it=document.getElementById("touch-controls"),l=new Dt,b=new Ct,k=new It(zt),te=new Ht(k),ee=new Bt(k,I),q=new Wt,ot=new $t(k),nt=new Jt,H=new Zt(jt,l,nt,I);let x=null;I&&(it.classList.remove("gb-controls--hidden"),x=new Ot,x.bind(it),x.on("action",n=>{switch(n){case"left":l.moveLeft();break;case"right":l.moveRight();break;case"softDrop":l.softDrop();break;case"hardDrop":l.hardDrop();break;case"rotateCW":l.rotateCW();break;case"rotateCCW":l.rotateCCW();break;case"hold":l.holdPiece();break;case"pause":l.togglePause();break}}));b.on("action",n=>{switch(n){case"left":l.moveLeft();break;case"right":l.moveRight();break;case"softDrop":l.softDrop();break;case"hardDrop":l.hardDrop();break;case"rotateCW":l.rotateCW();break;case"rotateCCW":l.rotateCCW();break;case"hold":l.holdPiece();break;case"pause":l.togglePause();break}});H.onPlay=()=>{l.startGame()};H.onResume=()=>{l.resume()};H.onReturnToMenu=()=>{l.returnToMenu()};l.on("game-over",n=>{nt.addScore({score:n.score,lines:n.lines,level:n.level,date:new Date().toISOString()})});l.on("lines-clearing",n=>{q.startLineClear(n)});l.on("lines-cleared",()=>{q.clear()});const se=702,ie=758,oe=I?210:0;function ct(){const n=window.innerWidth,t=window.innerHeight,e=ie+oe,s=Math.min(n/se,t/e,1);s<1?(D.style.transform=`scale(${s})`,D.style.marginBottom=`${-(e-e*s)}px`):(D.style.transform="",D.style.marginBottom="")}ct();window.addEventListener("resize",ct);let w=0,y=null,E=null;function F(n){const t=Math.min(n-(w||n),rt);w=n,k.clear(),ot.update(t),ot.draw(),y=requestAnimationFrame(F)}function lt(n){const t=Math.min(n-(w||n),rt);w=n,b.update(t),x&&x.update(t),l.update(t);const e=l.getState();k.clear(),te.draw(e),ee.draw(e),q.draw(k,e),E=requestAnimationFrame(lt)}function re(){y&&(cancelAnimationFrame(y),y=null)}function ne(){E&&(cancelAnimationFrame(E),E=null)}l.on("state-changed",n=>{n==="playing"?(re(),b.enable(),w=0,E||(E=requestAnimationFrame(lt))):n==="paused"?b.disable():n==="menu"?(ne(),b.disable(),w=0,y||(y=requestAnimationFrame(F))):n==="gameOver"&&b.disable()});w=0;y=requestAnimationFrame(F);H.showMenu();
