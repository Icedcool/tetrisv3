(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}})();const g=10,f=22,T=20,h=30,D=660,A=700,R=180,u=60,H=g*h,N=T*h,O=0,Q=510,ae="#0a0a2e",W="#111133",U="#3333aa",I="#ffffff",y="#8888bb",he="rgba(255, 255, 255, 0.15)",B={I:"#00f0f0",O:"#f0f000",T:"#a000f0",S:"#00f000",Z:"#f00000",J:"#0000f0",L:"#f0a000"},L=170,P=50,X=50,de=500,fe=15,q=200,j=50,F=[1e3,793,618,473,355,262,190,135,94,64,43,28,18,11,7,4,3,2,1,1],ue={1:100,2:300,3:500,4:800},_e=1,ge=2,pe=10,G=["I","O","T","S","Z","J","L"],M={I:[[[1,0],[1,1],[1,2],[1,3]],[[0,2],[1,2],[2,2],[3,2]],[[2,0],[2,1],[2,2],[2,3]],[[0,1],[1,1],[2,1],[3,1]]],O:[[[0,1],[0,2],[1,1],[1,2]],[[0,1],[0,2],[1,1],[1,2]],[[0,1],[0,2],[1,1],[1,2]],[[0,1],[0,2],[1,1],[1,2]]],T:[[[0,1],[1,0],[1,1],[1,2]],[[0,1],[1,1],[1,2],[2,1]],[[1,0],[1,1],[1,2],[2,1]],[[0,1],[1,0],[1,1],[2,1]]],S:[[[0,1],[0,2],[1,0],[1,1]],[[0,1],[1,1],[1,2],[2,2]],[[1,1],[1,2],[2,0],[2,1]],[[0,0],[1,0],[1,1],[2,1]]],Z:[[[0,0],[0,1],[1,1],[1,2]],[[0,2],[1,1],[1,2],[2,1]],[[1,0],[1,1],[2,1],[2,2]],[[0,1],[1,0],[1,1],[2,0]]],J:[[[0,0],[1,0],[1,1],[1,2]],[[0,1],[0,2],[1,1],[2,1]],[[1,0],[1,1],[1,2],[2,2]],[[0,1],[1,1],[2,0],[2,1]]],L:[[[0,2],[1,0],[1,1],[1,2]],[[0,1],[1,1],[2,1],[2,2]],[[1,0],[1,1],[1,2],[2,0]],[[0,0],[0,1],[1,1],[2,1]]]},me={"0>1":[[0,0],[0,-1],[-1,-1],[2,0],[2,-1]],"1>0":[[0,0],[0,1],[1,1],[-2,0],[-2,1]],"1>2":[[0,0],[0,1],[1,1],[-2,0],[-2,1]],"2>1":[[0,0],[0,-1],[-1,-1],[2,0],[2,-1]],"2>3":[[0,0],[0,1],[-1,1],[2,0],[2,1]],"3>2":[[0,0],[0,-1],[1,-1],[-2,0],[-2,-1]],"3>0":[[0,0],[0,-1],[1,-1],[-2,0],[-2,-1]],"0>3":[[0,0],[0,1],[-1,1],[2,0],[2,1]]},ye={"0>1":[[0,0],[0,-2],[0,1],[-1,-2],[2,1]],"1>0":[[0,0],[0,2],[0,-1],[1,2],[-2,-1]],"1>2":[[0,0],[0,-1],[0,2],[2,-1],[-1,2]],"2>1":[[0,0],[0,1],[0,-2],[-2,1],[1,-2]],"2>3":[[0,0],[0,2],[0,-1],[1,2],[-2,-1]],"3>2":[[0,0],[0,-2],[0,1],[-1,-2],[2,1]],"3>0":[[0,0],[0,1],[0,-2],[-2,1],[1,-2]],"0>3":[[0,0],[0,-1],[0,2],[2,-1],[-1,2]]},we=0,Se=3,ve=3,Re=20;class ee{constructor(){this._listeners=new Map}on(e,t){return this._listeners.has(e)||this._listeners.set(e,new Set),this._listeners.get(e).add(t),this}off(e,t){const s=this._listeners.get(e);return s&&(s.delete(t),s.size===0&&this._listeners.delete(e)),this}emit(e,...t){const s=this._listeners.get(e);if(s)for(const i of s)i(...t);return this}}class be{constructor(){this.grid=this._createGrid()}_createGrid(){return Array.from({length:f},()=>Array(g).fill(null))}reset(){this.grid=this._createGrid()}isValidPosition(e,t=0,s=0){const i=e.row+t,o=e.col+s;for(const[n,l]of e.cells){const c=i+n,d=o+l;if(c<0||c>=f||d<0||d>=g||this.grid[c][d]!==null)return!1}return!0}checkPosition(e,t,s){for(const[i,o]of e){const n=t+i,l=s+o;if(n<0||n>=f||l<0||l>=g||this.grid[n][l]!==null)return!1}return!0}placePiece(e){for(const[t,s]of e.cells){const i=e.row+t,o=e.col+s;i>=0&&i<f&&o>=0&&o<g&&(this.grid[i][o]=e.type)}}getFullRows(){const e=[];for(let t=0;t<f;t++)this.grid[t].every(s=>s!==null)&&e.push(t);return e}clearRows(e){const t=[...e].sort((s,i)=>i-s);for(const s of t)this.grid.splice(s,1);for(;this.grid.length<f;)this.grid.unshift(Array(g).fill(null))}getGhostRow(e){let t=0;for(;this.isValidPosition(e,t+1,0);)t++;return e.row+t}}class S{constructor(e){this.type=e,this.rotation=0,this.row=we,this.col=Se}get cells(){return M[this.type][this.rotation]}clone(){const e=new S(this.type);return e.rotation=this.rotation,e.row=this.row,e.col=this.col,e}absoluteCells(){return this.cells.map(([e,t])=>[this.row+e,this.col+t])}}class ke{constructor(){this._bag=[]}next(){return this._bag.length===0&&this._refill(),this._bag.pop()}peek(e){for(;this._bag.length<e;)this._refill();const t=[];for(let s=this._bag.length-1;s>=0&&t.length<e;s--)t.push(this._bag[s]);return t}reset(){this._bag=[]}_refill(){const e=[...G];for(let t=e.length-1;t>0;t--){const s=Math.floor(Math.random()*(t+1));[e[t],e[s]]=[e[s],e[t]]}this._bag=e.concat(this._bag)}}class Te extends ee{constructor(){super(),this.board=new be,this.bag=new ke,this._resetState()}_resetState(){this.state="menu",this.piece=null,this.holdType=null,this.holdUsed=!1,this.score=0,this.lines=0,this.level=1,this.nextQueue=[],this.gravityTimer=0,this.lockTimer=0,this.lockResets=0,this.isLocking=!1,this.clearingRows=null,this.clearTimer=0}startGame(){this.board.reset(),this.bag.reset(),this._resetState(),this.state="playing",this._fillNextQueue(),this._spawnPiece(),this.emit("state-changed",this.state),this.emit("game-started")}pause(){this.state==="playing"&&(this.state="paused",this.emit("state-changed",this.state))}resume(){this.state==="paused"&&(this.state="playing",this.emit("state-changed",this.state))}togglePause(){this.state==="playing"?this.pause():this.state==="paused"&&this.resume()}returnToMenu(){this._resetState(),this.board.reset(),this.emit("state-changed",this.state)}update(e){if(this.state!=="playing")return;if(this.clearingRows){this.clearTimer+=e,this.clearTimer>=q&&this._finishLineClear();return}if(!this.piece)return;const t=this._getGravityInterval();for(this.gravityTimer+=e;this.gravityTimer>=t&&this.piece&&!this.isLocking;)this.gravityTimer-=t,this._applyGravity();this.isLocking&&(this.lockTimer+=e,this.lockTimer>=de&&this._lockPiece())}moveLeft(){return this.state!=="playing"||!this.piece||this.clearingRows?!1:this.board.isValidPosition(this.piece,0,-1)?(this.piece.col--,this._onSuccessfulMove(),!0):!1}moveRight(){return this.state!=="playing"||!this.piece||this.clearingRows?!1:this.board.isValidPosition(this.piece,0,1)?(this.piece.col++,this._onSuccessfulMove(),!0):!1}softDrop(){return this.state!=="playing"||!this.piece||this.clearingRows?!1:this.board.isValidPosition(this.piece,1,0)?(this.piece.row++,this.score+=_e,this.gravityTimer=0,this._onSuccessfulMove(),this.emit("score-updated",this.score),!0):!1}hardDrop(){if(this.state!=="playing"||!this.piece||this.clearingRows)return!1;let e=0;for(;this.board.isValidPosition(this.piece,e+1,0);)e++;return this.piece.row+=e,this.score+=e*ge,this.emit("score-updated",this.score),this._lockPiece(),!0}rotateCW(){return this._rotate(1)}rotateCCW(){return this._rotate(-1)}holdPiece(){if(this.state!=="playing"||!this.piece||this.holdUsed||this.clearingRows)return!1;const e=this.piece.type;if(this.holdType){if(this.piece=new S(this.holdType),!this.board.isValidPosition(this.piece)&&(this.piece.row--,!this.board.isValidPosition(this.piece)))return this.piece=new S(e),!1}else{this._fillNextQueue();const t=this.nextQueue.shift();if(this.nextQueue.push(this.bag.next()),this.piece=new S(t),!this.board.isValidPosition(this.piece)&&(this.piece.row--,!this.board.isValidPosition(this.piece)))return this._gameOver(),!1;this.emit("next-updated",this.nextQueue.slice())}return this.holdType=e,this.holdUsed=!0,this.isLocking=!1,this.lockTimer=0,this.lockResets=0,this.gravityTimer=0,this.emit("hold-changed",this.holdType),!0}getState(){return{state:this.state,board:this.board.grid,piece:this.piece,ghostRow:this.piece?this.board.getGhostRow(this.piece):null,holdType:this.holdType,holdUsed:this.holdUsed,nextQueue:this.nextQueue.slice(),score:this.score,lines:this.lines,level:this.level,clearingRows:this.clearingRows,clearProgress:this.clearingRows?this.clearTimer/q:0}}_fillNextQueue(){for(;this.nextQueue.length<ve;)this.nextQueue.push(this.bag.next())}_spawnPiece(){this._fillNextQueue();const e=this.nextQueue.shift();if(this.nextQueue.push(this.bag.next()),this.piece=new S(e),this.isLocking=!1,this.lockTimer=0,this.lockResets=0,this.gravityTimer=0,this.holdUsed=!1,!this.board.isValidPosition(this.piece)&&(this.piece.row--,!this.board.isValidPosition(this.piece))){this._gameOver();return}this.emit("next-updated",this.nextQueue.slice())}_applyGravity(){this.board.isValidPosition(this.piece,1,0)?(this.piece.row++,this._checkLanding()):this.isLocking||(this.isLocking=!0,this.lockTimer=0)}_checkLanding(){this.board.isValidPosition(this.piece,1,0)?(this.isLocking=!1,this.lockTimer=0):this.isLocking||(this.isLocking=!0,this.lockTimer=0)}_onSuccessfulMove(){this.isLocking&&this.lockResets<fe&&(this.lockTimer=0,this.lockResets++),this._checkLanding()}_rotate(e){if(this.state!=="playing"||!this.piece||this.clearingRows||this.piece.type==="O")return!1;const t=this.piece.rotation,s=(t+e+4)%4,i=`${t}>${s}`,n=(this.piece.type==="I"?ye:me)[i];if(!n)return!1;const l=M[this.piece.type][s];for(const[c,d]of n)if(this.board.checkPosition(l,this.piece.row+c,this.piece.col+d))return this.piece.rotation=s,this.piece.row+=c,this.piece.col+=d,this._onSuccessfulMove(),!0;return!1}_lockPiece(){this.board.placePiece(this.piece),this.emit("piece-locked",this.piece);const e=this.board.getFullRows();e.length>0?(this.clearingRows=e,this.clearTimer=0,this.piece=null,this.emit("lines-clearing",e)):(this.piece=null,this._spawnPiece())}_finishLineClear(){const e=this.clearingRows.length;this.board.clearRows(this.clearingRows),this.clearingRows=null,this.clearTimer=0;const t=(ue[e]||0)*this.level;this.score+=t,this.lines+=e;const s=Math.floor(this.lines/pe)+1;s!==this.level&&(this.level=s),this.emit("lines-cleared",e),this.emit("score-updated",this.score),this._spawnPiece()}_getGravityInterval(){const e=Math.min(this.level-1,F.length-1);return F[e]}_gameOver(){this.state="gameOver",this.piece=null,this.emit("game-over",{score:this.score,lines:this.lines,level:this.level}),this.emit("state-changed",this.state)}}const Y={ArrowLeft:"left",ArrowRight:"right",ArrowDown:"softDrop",ArrowUp:"rotateCW",KeyX:"rotateCW",KeyZ:"rotateCCW",Space:"hardDrop",ShiftLeft:"hold",ShiftRight:"hold",KeyC:"hold",Escape:"pause",KeyP:"pause"};class Ee extends ee{constructor(){super(),this._keys=new Set,this._dasTimers={left:0,right:0},this._dasActive={left:!1,right:!1},this._softDropTimer=0,this._enabled=!1,this._onKeyDown=this._onKeyDown.bind(this),this._onKeyUp=this._onKeyUp.bind(this)}enable(){this._enabled||(this._enabled=!0,window.addEventListener("keydown",this._onKeyDown),window.addEventListener("keyup",this._onKeyUp))}disable(){this._enabled=!1,window.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("keyup",this._onKeyUp),this._keys.clear()}update(e){if(this._keys.has("left"))if(this._dasTimers.left+=e,this._dasActive.left)for(;this._dasTimers.left>=P;)this._dasTimers.left-=P,this.emit("action","left");else this._dasTimers.left>=L&&(this._dasActive.left=!0,this._dasTimers.left-=L,this.emit("action","left"));if(this._keys.has("right"))if(this._dasTimers.right+=e,this._dasActive.right)for(;this._dasTimers.right>=P;)this._dasTimers.right-=P,this.emit("action","right");else this._dasTimers.right>=L&&(this._dasActive.right=!0,this._dasTimers.right-=L,this.emit("action","right"));if(this._keys.has("softDrop"))for(this._softDropTimer+=e;this._softDropTimer>=X;)this._softDropTimer-=X,this.emit("action","softDrop")}_onKeyDown(e){const t=Y[e.code];if(t&&(e.preventDefault(),!this._keys.has(t)))switch(this._keys.add(t),t){case"left":this._dasTimers.left=0,this._dasActive.left=!1,this.emit("action","left");break;case"right":this._dasTimers.right=0,this._dasActive.right=!1,this.emit("action","right");break;case"softDrop":this._softDropTimer=0,this.emit("action","softDrop");break;case"rotateCW":case"rotateCCW":case"hardDrop":case"hold":case"pause":this.emit("action",t);break}}_onKeyUp(e){const t=Y[e.code];t&&(this._keys.delete(t),t==="left"&&(this._dasTimers.left=0,this._dasActive.left=!1),t==="right"&&(this._dasTimers.right=0,this._dasActive.right=!1),t==="softDrop"&&(this._softDropTimer=0))}}class xe{constructor(e){this.canvas=e,this.ctx=e.getContext("2d"),this.canvas.width=D,this.canvas.height=A}clear(){this.ctx.fillStyle=ae,this.ctx.fillRect(0,0,D,A)}drawBlock(e,t,s,i,o=1){const n=this.ctx,l=typeof i=="string"&&B[i]?B[i]:i;n.globalAlpha=o,n.fillStyle=l,n.fillRect(e,t,s,s),n.fillStyle="rgba(255, 255, 255, 0.2)",n.fillRect(e,t,s,1),n.fillRect(e,t,1,s),n.fillStyle="rgba(0, 0, 0, 0.3)",n.fillRect(e,t+s-1,s,1),n.fillRect(e+s-1,t,1,s),n.globalAlpha=1}drawBoardBackground(){const e=this.ctx;e.fillStyle=W,e.fillRect(R,u,H,N),e.strokeStyle=U,e.lineWidth=2,e.strokeRect(R-1,u-1,H+2,N+2)}}class Le{constructor(e){this.renderer=e,this.ctx=e.ctx}draw(e){this.renderer.drawBoardBackground(),this._drawLockedBlocks(e.board),e.piece&&!e.clearingRows&&(this._drawGhost(e.piece,e.ghostRow),this._drawActivePiece(e.piece))}_drawLockedBlocks(e){const t=f-T;for(let s=t;s<f;s++)for(let i=0;i<g;i++){const o=e[s][i];if(o){const n=R+i*h,l=u+(s-t)*h;this.renderer.drawBlock(n,l,h,o)}}}_drawGhost(e,t){const s=f-T;for(const[i,o]of e.cells){const n=t+i,l=e.col+o;if(n>=s){const c=R+l*h,d=u+(n-s)*h,_=this.ctx;_.fillStyle=he,_.fillRect(c,d,h,h),_.strokeStyle="rgba(255, 255, 255, 0.2)",_.lineWidth=1,_.strokeRect(c+.5,d+.5,h-1,h-1)}}}_drawActivePiece(e){const t=f-T;for(const[s,i]of e.cells){const o=e.row+s,n=e.col+i;if(o>=t){const l=R+n*h,c=u+(o-t)*h;this.renderer.drawBlock(l,c,h,e.type)}}}}class Pe{constructor(e){this.renderer=e,this.ctx=e.ctx}draw(e){this._drawHold(e),this._drawNext(e),this._drawScore(e),this._drawLevel(e),this._drawControls()}_drawHold(e){const t=this.ctx,s=O+15,i=u,o=120,n=80;if(t.fillStyle=y,t.font='12px "Segoe UI", sans-serif',t.textAlign="center",t.fillText("HOLD",s+o/2,i-8),t.fillStyle=W,t.fillRect(s,i,o,n),t.strokeStyle=U,t.lineWidth=1,t.strokeRect(s,i,o,n),e.holdType){const l=e.holdUsed?.3:1;this._drawPreviewPiece(e.holdType,s+o/2,i+n/2,l)}}_drawNext(e){const t=this.ctx,s=Q+15,i=u,o=120,n=60;t.fillStyle=y,t.font='12px "Segoe UI", sans-serif',t.textAlign="center",t.fillText("NEXT",s+o/2,i-8);const l=n*e.nextQueue.length;t.fillStyle=W,t.fillRect(s,i,o,l),t.strokeStyle=U,t.lineWidth=1,t.strokeRect(s,i,o,l);for(let c=0;c<e.nextQueue.length;c++)this._drawPreviewPiece(e.nextQueue[c],s+o/2,i+n/2+c*n,1)}_drawScore(e){const t=this.ctx,s=O+75,i=u+120;t.textAlign="center",t.fillStyle=y,t.font='12px "Segoe UI", sans-serif',t.fillText("SCORE",s,i),t.fillStyle=I,t.font='bold 20px "Segoe UI", sans-serif',t.fillText(e.score.toLocaleString(),s,i+24),t.fillStyle=y,t.font='12px "Segoe UI", sans-serif',t.fillText("LINES",s,i+56),t.fillStyle=I,t.font='bold 20px "Segoe UI", sans-serif',t.fillText(e.lines.toString(),s,i+80)}_drawLevel(e){const t=this.ctx,s=Q+75,i=u+220;t.textAlign="center",t.fillStyle=y,t.font='12px "Segoe UI", sans-serif',t.fillText("LEVEL",s,i),t.fillStyle=I,t.font='bold 24px "Segoe UI", sans-serif',t.fillText(e.level.toString(),s,i+28)}_drawControls(){const e=this.ctx,t=O+75,s=u+N-120;e.textAlign="center",e.fillStyle=y,e.font='10px "Segoe UI", sans-serif',["← → Move","↑ / X  Rotate CW","Z  Rotate CCW","↓  Soft Drop","Space  Hard Drop","Shift/C  Hold","Esc/P  Pause"].forEach((o,n)=>{e.fillText(o,t,s+n*16)})}_drawPreviewPiece(e,t,s,i){const o=M[e][0],n=Re;let l=1/0,c=-1/0,d=1/0,_=-1/0;for(const[E,x]of o)l=Math.min(l,E),c=Math.max(c,E),d=Math.min(d,x),_=Math.max(_,x);const ie=(_-d+1)*n,oe=(c-l+1)*n,ne=t-ie/2,re=s-oe/2;for(const[E,x]of o){const le=ne+(x-d)*n,ce=re+(E-l)*n;this.renderer.drawBlock(le,ce,n,e,i)}}}class Ae{constructor(){this._clearingRows=null}startLineClear(e){this._clearingRows=e}clear(){this._clearingRows=null}draw(e,t){if(!t.clearingRows||t.clearProgress===void 0)return;const s=e.ctx,i=f-T,o=t.clearProgress,n=.6*Math.abs(Math.sin(o*Math.PI*2));s.fillStyle=`rgba(255, 255, 255, ${n})`;for(const l of t.clearingRows)if(l>=i){const c=u+(l-i)*h;s.fillRect(R,c,H,h)}}}const Me=12,Ce=30,Oe=80,Ie=.1,De=.3,He=15,Ne=25;function w(r,e){return r+Math.random()*(e-r)}function Z(){const r=G[Math.floor(Math.random()*G.length)],e=Math.floor(Math.random()*4);return{type:r,rotation:e,x:w(0,D),y:w(-200,-20),speed:w(Ce,Oe),opacity:w(Ie,De),cellSize:w(He,Ne)}}class We{constructor(e){this.renderer=e,this.ctx=e.ctx,this._pieces=[];for(let t=0;t<Me;t++){const s=Z();s.y=w(-200,A),this._pieces.push(s)}}update(e){const t=e/1e3;for(const s of this._pieces)s.y+=s.speed*t,s.y>A+100&&Object.assign(s,Z())}draw(){for(const e of this._pieces){const t=M[e.type][e.rotation],s=B[e.type],i=this.ctx;i.globalAlpha=e.opacity;for(const[o,n]of t){const l=e.x+n*e.cellSize,c=e.y+o*e.cellSize;i.fillStyle=s,i.fillRect(l,c,e.cellSize,e.cellSize),i.strokeStyle="rgba(255,255,255,0.1)",i.lineWidth=1,i.strokeRect(l+.5,c+.5,e.cellSize-1,e.cellSize-1)}}this.ctx.globalAlpha=1}}class Ue{constructor(e,t){this._container=e,this._highScores=t,this._el=null,this._keyHandler=null,this.onPlay=null}show(){this._el&&this.hide();const e=document.createElement("div");e.className="overlay",e.innerHTML=`
      <div class="overlay__title">TETRIS</div>
      <button class="overlay__btn" data-action="play">PLAY</button>
      <div class="overlay__high-scores"></div>
      <div class="overlay__controls">
        ← → Move &nbsp;|&nbsp; ↑/X Rotate CW &nbsp;|&nbsp; Z Rotate CCW<br>
        ↓ Soft Drop &nbsp;|&nbsp; Space Hard Drop &nbsp;|&nbsp; Shift/C Hold<br>
        Esc/P Pause
      </div>
    `,e.querySelector('[data-action="play"]').addEventListener("click",()=>{this.onPlay&&this.onPlay()}),this._keyHandler=t=>{(t.code==="Enter"||t.code==="Space")&&(t.preventDefault(),this.onPlay&&this.onPlay())},window.addEventListener("keydown",this._keyHandler),this._renderScores(e.querySelector(".overlay__high-scores")),this._container.appendChild(e),this._el=e}hide(){this._keyHandler&&(window.removeEventListener("keydown",this._keyHandler),this._keyHandler=null),this._el&&(this._el.remove(),this._el=null)}_renderScores(e){const t=this._highScores.getScores();if(t.length===0)return;let s="<h3>High Scores</h3><ol>";for(const i of t)s+=`<li>${i.score.toLocaleString()} — Lv.${i.level} — ${i.lines} lines</li>`;s+="</ol>",e.innerHTML=s}}class Be{constructor(e){this._container=e,this._el=null,this._keyHandler=null,this.onResume=null,this.onMenu=null}show(){this._el&&this.hide();const e=document.createElement("div");e.className="overlay overlay--dim",e.innerHTML=`
      <div class="overlay__title">PAUSED</div>
      <button class="overlay__btn" data-action="resume">RESUME</button>
      <button class="overlay__btn" data-action="menu">MAIN MENU</button>
      <div class="overlay__controls" style="margin-top:20px">Press Esc to resume</div>
    `,e.querySelector('[data-action="resume"]').addEventListener("click",()=>{this.onResume&&this.onResume()}),e.querySelector('[data-action="menu"]').addEventListener("click",()=>{this.onMenu&&this.onMenu()}),this._keyHandler=t=>{(t.code==="Escape"||t.code==="KeyP")&&(t.preventDefault(),this.onResume&&this.onResume())},window.addEventListener("keydown",this._keyHandler),this._container.appendChild(e),this._el=e,e.querySelector('[data-action="resume"]').focus()}hide(){this._keyHandler&&(window.removeEventListener("keydown",this._keyHandler),this._keyHandler=null),this._el&&(this._el.remove(),this._el=null)}}class Ge{constructor(e,t){this._container=e,this._highScores=t,this._el=null,this.onRestart=null,this.onMenu=null}show(e){this._el&&this.hide();const t=this._highScores.isHighScore(e.score),s=document.createElement("div");s.className="overlay overlay--dim",s.innerHTML=`
      <div class="overlay__title">GAME OVER</div>
      ${t?'<div class="overlay__new-high">NEW HIGH SCORE!</div>':""}
      <div class="overlay__score">Score: ${e.score.toLocaleString()}</div>
      <div class="overlay__subtitle">Level ${e.level} — ${e.lines} Lines</div>
      <button class="overlay__btn" data-action="restart">PLAY AGAIN</button>
      <button class="overlay__btn" data-action="menu">MAIN MENU</button>
    `,s.querySelector('[data-action="restart"]').addEventListener("click",()=>{this.onRestart&&this.onRestart()}),s.querySelector('[data-action="menu"]').addEventListener("click",()=>{this.onMenu&&this.onMenu()}),this._container.appendChild(s),this._el=s,s.querySelector('[data-action="restart"]').focus()}hide(){this._el&&(this._el.remove(),this._el=null)}}class Ke{constructor(e,t,s){this._container=e,this._engine=t,this._highScores=s,this.menu=new Ue(e,s),this.pause=new Be(e),this.gameOver=new Ge(e,s),this.onPlay=null,this.onResume=null,this.onReturnToMenu=null,this._wireScreenCallbacks(),this._wireEngineEvents()}_wireScreenCallbacks(){this.menu.onPlay=()=>{this.menu.hide(),this.onPlay&&this.onPlay()},this.pause.onResume=()=>{this.pause.hide(),this.onResume&&this.onResume()},this.pause.onMenu=()=>{this.pause.hide(),this.onReturnToMenu&&this.onReturnToMenu()},this.gameOver.onRestart=()=>{this.gameOver.hide(),this.onPlay&&this.onPlay()},this.gameOver.onMenu=()=>{this.gameOver.hide(),this.onReturnToMenu&&this.onReturnToMenu()}}_wireEngineEvents(){this._engine.on("state-changed",e=>{switch(this._hideAll(),e){case"menu":this.menu.show();break;case"paused":this.pause.show();break}}),this._engine.on("game-over",e=>{setTimeout(()=>{this.gameOver.show(e)},300)})}_hideAll(){this.menu.hide(),this.pause.hide(),this.gameOver.hide()}showMenu(){this._hideAll(),this.menu.show()}}const $="tetrisv3_highscores",J=10;class Ve{getScores(){try{const e=localStorage.getItem($);return e?JSON.parse(e):[]}catch{return[]}}addScore(e){const t=this.getScores();t.push(e),t.sort((i,o)=>o.score-i.score);const s=t.slice(0,J);try{localStorage.setItem($,JSON.stringify(s))}catch{}return s}isHighScore(e){const t=this.getScores();return t.length<J?!0:e>t[t.length-1].score}}const Qe=document.getElementById("game-canvas"),Xe=document.getElementById("overlay-container"),a=new Te,v=new Ee,k=new xe(Qe),qe=new Le(k),Fe=new Pe(k),K=new Ae,z=new We(k),te=new Ve,C=new Ke(Xe,a,te);v.on("action",r=>{switch(r){case"left":a.moveLeft();break;case"right":a.moveRight();break;case"softDrop":a.softDrop();break;case"hardDrop":a.hardDrop();break;case"rotateCW":a.rotateCW();break;case"rotateCCW":a.rotateCCW();break;case"hold":a.holdPiece();break;case"pause":a.togglePause();break}});C.onPlay=()=>{a.startGame()};C.onResume=()=>{a.resume()};C.onReturnToMenu=()=>{a.returnToMenu()};a.on("game-over",r=>{te.addScore({score:r.score,lines:r.lines,level:r.level,date:new Date().toISOString()})});a.on("lines-clearing",r=>{K.startLineClear(r)});a.on("lines-cleared",()=>{K.clear()});let m=0,p=null,b=null;function V(r){const e=Math.min(r-(m||r),j);m=r,k.clear(),z.update(e),z.draw(),p=requestAnimationFrame(V)}function se(r){const e=Math.min(r-(m||r),j);m=r,v.update(e),a.update(e);const t=a.getState();k.clear(),qe.draw(t),Fe.draw(t),K.draw(k,t),b=requestAnimationFrame(se)}function Ye(){p&&(cancelAnimationFrame(p),p=null)}function Ze(){b&&(cancelAnimationFrame(b),b=null)}a.on("state-changed",r=>{r==="playing"?(Ye(),v.enable(),m=0,b||(b=requestAnimationFrame(se))):r==="paused"?v.disable():r==="menu"?(Ze(),v.disable(),m=0,p||(p=requestAnimationFrame(V))):r==="gameOver"&&v.disable()});m=0;p=requestAnimationFrame(V);C.showMenu();
